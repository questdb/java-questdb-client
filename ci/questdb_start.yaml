parameters:
  - name: configPath
    type: string

steps:
  - bash: |
      mkdir -p questdb-data
      cp -r ${{ parameters.configPath }} questdb-data/conf

      mkdir -p logs

      # Start QuestDB in the background
      java -p questdb/core/target/questdb-*-SNAPSHOT.jar -m io.questdb/io.questdb.ServerMain -d questdb-data > logs/questdb.log 2>&1 &
      echo $! > questdb.pid

      # Wait for QuestDB to start
      echo "Waiting for QuestDB to start..."
      for i in {1..30}; do
        if grep -q "server-main enjoy" logs/questdb.log; then
          echo "Server started."
          break
        else
          echo "Waiting..."
          sleep 2
        fi
      done

      if ! grep -q "server-main enjoy" logs/questdb.log; then
        echo "QuestDB failed to start:"
        cat logs/questdb.log
        exit 1
      fi
    displayName: "Start QuestDB server (non-Windows)"
    condition: ne(variables['Agent.OS'], 'Windows_NT')
  - pwsh: |
      New-Item -ItemType Directory -Force -Path questdb-data | Out-Null
      New-Item -ItemType Directory -Force -Path logs | Out-Null
      Copy-Item -Recurse -Force -Path "${{ parameters.configPath }}" -Destination "questdb-data/conf"

      $proc = Start-Process -FilePath "java" -ArgumentList @(
        "-p", "questdb/core/target/questdb-*-SNAPSHOT.jar",
        "-m", "io.questdb/io.questdb.ServerMain",
        "-d", "questdb-data"
      ) -RedirectStandardOutput "logs/questdb.log" -RedirectStandardError "logs/questdb.log" -PassThru

      $proc.Id | Out-File -FilePath questdb.pid -Encoding ascii

      Write-Host "Waiting for QuestDB to start..."
      $started = $false
      for ($i = 0; $i -lt 30; $i++) {
        if (Test-Path "logs/questdb.log") {
          if (Select-String -Path "logs/questdb.log" -Pattern "server-main enjoy" -Quiet) {
            Write-Host "Server started."
            $started = $true
            break
          }
        }
        Write-Host "Waiting..."
        Start-Sleep -Seconds 2
      }

      if (-not $started) {
        Write-Host "QuestDB failed to start:"
        if (Test-Path "logs/questdb.log") {
          Get-Content "logs/questdb.log"
        }
        exit 1
      }
    displayName: "Start QuestDB server (Windows)"
    condition: eq(variables['Agent.OS'], 'Windows_NT')
