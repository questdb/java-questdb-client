parameters:
  - name: configPath
    type: string

steps:
  - bash: |
      echo "Stopping QuestDB server..."
      pkill -f io.questdb.ServerMain

      # Remove any existing data
      rm -rf questdb-data
      mkdir -p questdb-data
      cp -r ${{ parameters.configPath }} questdb-data/conf

      mkdir -p logs

      # Start QuestDB in the background
      java -p questdb/core/target/questdb-*-SNAPSHOT.jar -m io.questdb/io.questdb.ServerMain -d questdb-data > logs/questdb.log 2>&1 &

      # Wait for QuestDB to start
      echo "Waiting for QuestDB to start..."
      for i in {1..30}; do
        if grep -q "server-main enjoy" logs/questdb.log; then
          echo "Server started."
          break
        else
          echo "Waiting..."
          sleep 2
        fi
      done

      if ! grep -q "server-main enjoy" logs/questdb.log; then
        echo "QuestDB failed to start:"
        cat logs/questdb.log
        exit 1
      fi
    displayName: "Start QuestDB server"
