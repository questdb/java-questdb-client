# Run the tests from OSS using the current client version
steps:
  - task: Maven@3
    displayName: "Update client version"
    inputs:
      mavenPOMFile: "core/pom.xml"
      jdkVersionOption: "default"
      goals: "versions:set"
      options: "-DnewVersion=9.9.9 -DgenerateBackupPoms=false"
  - task: Maven@3
    displayName: "Install client to local repo"
    inputs:
      mavenPOMFile: "pom.xml"
      jdkVersionOption: "default"
      goals: "install"
  - task: Maven@3
    displayName: "Update QuestDB client version"
    inputs:
      mavenPOMFile: "questdb/core/pom.xml"
      jdkVersionOption: "default"
      goals: "versions:use-dep-version"
      options: "-Dincludes=org.questdb:client -DdepVersion=9.9.9 -DforceVersion=true"
  - task: Maven@3
    displayName: "Run OSS line tests"
    inputs:
      mavenPOMFile: "questdb/pom.xml"
      jdkVersionOption: "default"
      goals: "clean test"
      options: "--batch-mode --quiet
        -Dtest.include=**/cutlass/http/line/*,**/cutlass/line/**/*
        -DfailIfNoTests=false
        -Dsurefire.failIfNoSpecifiedTests=false
        -Dout=$(Build.SourcesDirectory)/questdb/ci/qlog.conf
        -Dhttp.keepAlive=false"
  - task: ArchiveFiles@2
    displayName: "Tests failed -- Compress logs"
    condition: failed()
    inputs:
      rootFolderOrFile: "logs"
      includeRootFolder: false
      archiveFile: $(ARCHIVED_LOGS)
  - task: PublishBuildArtifacts@1
    displayName: "Tests failed -- Upload logs"
    condition: failed()
    inputs:
      pathToPublish: $(ARCHIVED_LOGS)
      artifactName: MavenFailedTestsLogs
